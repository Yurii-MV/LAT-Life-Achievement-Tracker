<!doctype html>
<html lang="uk">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Life Achievement Tracker</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --app-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--app-gradient);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .stats {
        display: flex;
        gap: 20px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        padding: 20px 30px;
        border-radius: 15px;
        color: white;
        text-align: center;
        min-width: 150px;
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        display: block;
      }

      .stat-label {
        font-size: 0.9em;
        opacity: 0.9;
        margin-top: 5px;
      }

      .categories {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .category {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
      }

      .category.collapsed {
        padding-bottom: 20px;
      }

      .category-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
        user-select: none;
      }

      .category-header-top {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin-bottom: 10px;
      }

      .category-header-top:hover {
        opacity: 0.8;
      }

      .category-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        padding-left: 60px;
      }

      .category.collapsed .category-header {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .category-icon {
        font-size: 2em;
        margin-right: 15px;
      }

      .category-title {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
        flex: 1;
      }

      .collapse-toggle {
        /* background removed ‚Äî gradient will apply to the text only */
        background: transparent;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        padding: 5px;
        margin-right: 10px;
        transition: transform 0.3s ease;
        color: white; /* fallback for browsers that don't support text-clip */
        border-radius: 6px;
        display: inline-block;

        /* apply gradient to the TEXT (uses --app-gradient set by settings) */
        background-image: var(--app-gradient);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .collapse-toggle:hover {
        transform: scale(1.2);
      }

      .category.collapsed .collapse-toggle {
        transform: rotate(-90deg);
      }

      .category-items {
        overflow: hidden;
        transition:
          max-height 0.3s ease,
          opacity 0.3s ease;
      }

      .category.collapsed .category-items {
        max-height: 0;
        opacity: 0;
      }

      .achievement {
        display: flex;
        flex-direction: column;
        padding: 12px;
        margin: 8px 0;
        border-radius: 10px;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
      }

      .achievement-main {
        display: flex;
        align-items: center;
        width: 100%;
      }

      .achievement:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .achievement.unlocked {
        background: var(--app-gradient);
        color: white;
      }

      .achievement.unlocked .achievement-icon {
        filter: grayscale(0%) brightness(1.2);
      }

      .achievement.locked {
        opacity: 0.6;
      }

      .achievement.locked .achievement-icon {
        filter: grayscale(100%);
      }

      .achievement-icon {
        font-size: 2em;
        margin-right: 15px;
        transition: all 0.3s ease;
        cursor: zoom-in;
      }

      .achievement-content {
        flex: 1;
      }

      .achievement-name {
        font-weight: bold;
        margin-bottom: 3px;
      }

      .achievement-description {
        font-size: 0.85em;
        opacity: 0.8;
      }

      .achievement-controls {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
      }

      .achievement.unlocked .achievement-controls {
        border-top-color: rgba(255, 255, 255, 0.2);
      }

      .achievement-controls .sort-controls {
        margin-right: 0;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        margin-top: 8px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        transition: width 0.5s ease;
      }

      .unlock-animation {
        animation: unlockPulse 0.6s ease;
      }

      @keyframes unlockPulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 400px;
        animation: modalAppear 0.5s ease;
      }

      @keyframes modalAppear {
        from {
          transform: scale(0.8);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .modal-icon {
        font-size: 5em;
        margin-bottom: 20px;
      }

      .image-modal-content {
        max-width: 90%;
        max-height: 90%;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .image-modal-content img {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 10px;
        box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
        cursor: pointer;
      }

      .modal h2 {
        color: #667eea;
        margin-bottom: 10px;
      }

      .modal p {
        color: #666;
        margin-bottom: 20px;
      }

      .modal button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        transition: transform 0.2s ease;
      }

      .modal button:hover {
        transform: scale(1.05);
      }

      .add-achievement-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: var(--app-gradient);
        color: white;
        border: none;
        font-size: 2em;
        cursor: pointer;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s ease;
      }

      .add-achievement-btn:hover {
        transform: scale(1.1);
      }

      .form-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1000;
        overflow-y: auto;
      }

      .form-modal.active {
        display: flex;
      }

      .form-content {
        background: white;
        padding: 30px;
        border-radius: 20px;
        max-width: 500px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: modalAppear 0.5s ease;
      }

      .form-content h2 {
        color: #667eea;
        margin-bottom: 20px;
        text-align: center;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        font-family: inherit;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: #667eea;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .image-upload-area {
        border: 2px dashed #667eea;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .image-upload-area:hover {
        background: #f8f9ff;
      }

      .image-upload-area.has-image {
        border-style: solid;
      }

      .preview-image {
        max-width: 150px;
        max-height: 150px;
        margin: 10px auto;
        display: block;
        border-radius: 8px;
      }

      .upload-icon {
        font-size: 3em;
        color: #667eea;
        margin-bottom: 10px;
      }

      .upload-text {
        color: #666;
        font-size: 0.9em;
      }

      .form-buttons {
        display: flex;
        gap: 10px;
        margin-top: 25px;
      }

      .btn {
        flex: 1;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .btn-primary {
        background: var(--app-gradient);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #e0e0e0;
        color: #333;
      }

      .btn-secondary:hover {
        background: #d0d0d0;
      }

      .action-btn {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 255, 255, 0.3);
        color: white;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
        display: none;
        align-items: center;
        justify-content: center;
      }

      .edit-mode .action-btn {
        display: flex;
      }

      .achievement.locked .action-btn {
        background: rgba(0, 0, 0, 0.1);
        color: #666;
      }

      .action-btn:hover {
        transform: scale(1.1);
      }

      .edit-btn:hover {
        background: #4caf50;
      }

      .delete-btn:hover {
        background: #f44336;
      }

      .custom-image {
        width: 40px;
        height: 40px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 15px;
      }

      .sort-btn {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border: none;
        padding: 6px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85em;
        transition: all 0.2s ease;
        margin-right: 5px;
      }

      .sort-btn:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: scale(1.05);
      }

      .sort-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .category-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        margin-left: auto;
      }

      .category-action-btn {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1.2em;
        transition: all 0.2s ease;
        display: none;
        align-items: center;
        justify-content: center;
        min-width: 36px;
      }

      .edit-mode .category-action-btn {
        display: flex;
      }

      .category-action-btn:hover {
        background: rgba(102, 126, 234, 0.2);
        transform: scale(1.1);
      }

      .category-action-btn.delete {
        background: rgba(244, 67, 54, 0.1);
        color: #f44336;
      }

      .category-action-btn.delete:hover {
        background: rgba(244, 67, 54, 0.2);
      }

      .add-category-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s ease;
      }

      .add-category-btn:hover {
        transform: scale(1.05);
      }

      .category-form-group {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .full-width {
        grid-column: 1 / -1;
      }

      .header-actions {
        text-align: center;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        justify-content: center;
        align-items: center;
      }

      .header-actions button {
        background: var(--app-gradient);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      }

      .header-actions button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
      }

      .settings-toggle-btn {
        background: rgba(102, 126, 234, 0.15) !important;
        color: #667eea !important;
      }

      .settings-toggle-btn.active {
        background: var(--app-gradient) !important;
        color: white !important;
      }

      .sort-controls {
        display: none;
        gap: 3px;
      }

      .edit-mode .sort-controls {
        display: flex;
      }

      .warning-text {
        color: #f44336;
        font-size: 0.9em;
        margin-top: 10px;
        padding: 10px;
        background: rgba(244, 67, 54, 0.1);
        border-radius: 5px;
      }

      .reset-btn {
        position: fixed;
        bottom: 30px;
        left: 30px;
        background: rgba(244, 67, 54, 0.9);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        display: none;
        align-items: center;
        gap: 8px;
      }

      .edit-mode .reset-btn {
        display: flex;
      }

      .reset-btn:hover {
        background: rgba(244, 67, 54, 1);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
      }

      .confirm-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        justify-content: center;
        align-items: center;
        z-index: 1001;
      }

      .confirm-modal.active {
        display: flex;
      }

      .confirm-content {
        background: white;
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        max-width: 450px;
        animation: modalAppear 0.5s ease;
      }

      .confirm-icon {
        font-size: 4em;
        margin-bottom: 20px;
      }

      .confirm-content h2 {
        color: #f44336;
        margin-bottom: 15px;
      }

      .confirm-content p {
        color: #666;
        margin-bottom: 25px;
        line-height: 1.6;
      }

      .confirm-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
      }

      .confirm-buttons button {
        padding: 12px 30px;
        border: none;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
      }

      .confirm-buttons .btn-cancel {
        background: #e0e0e0;
        color: #333;
      }

      .confirm-buttons .btn-cancel:hover {
        background: #d0d0d0;
      }

      .confirm-buttons .btn-confirm {
        background: #f44336;
        color: white;
      }

      .confirm-buttons .btn-confirm:hover {
        background: #d32f2f;
        transform: scale(1.05);
      }

      input[type='file'] {
        display: none;
      }

      .emoji-picker {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        margin-top: 10px;
      }

      .emoji-option {
        font-size: 1.5em;
        padding: 8px;
        cursor: pointer;
        border-radius: 5px;
        text-align: center;
        transition: all 0.2s ease;
      }

      .emoji-option:hover {
        background: #f0f0f0;
        transform: scale(1.2);
      }
    </style>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="appicon.png" sizes="192x192" type="image/png" />
    <link rel="icon" href="appicon.svg" sizes="any" type="image/svg+xml" />
    <link rel="shortcut icon" href="appicon.png" />
    <meta name="theme-color" content="#667eea" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="apple-mobile-web-app-title" content="LAT" />
    <link rel="apple-touch-icon" href="appicon.svg" />
  </head>
  <body>
    <div class="container">
      <header>
        <h1>üèÜ Life Achievement Tracker</h1>
        <p>–í—ñ–¥–∑–Ω–∞—á–∞–π –≤–∞—à—ñ —É—Å–ø—ñ—Ö–∏ —Ç–∞ —Ä–æ–∑–≤–∏–≤–∞–π—Ç–µ—Å—è!</p>
      </header>
      <div class="header-actions">
        <button
          class="settings-toggle-btn"
          onclick="toggleEditMode()"
          id="editModeBtn"
        >
          ‚öôÔ∏è
        </button>
      </div>
      <div
        class="header-actions extra-buttons"
        id="extraButtons"
        style="display: none"
      >
        <button onclick="openCategoryModal()" title="–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é">
          <strong>üì¶</strong>
        </button>
        <button onclick="exportData()" title="–ï–∫—Å–ø–æ—Ä—Ç">üíæ</button>
        <button onclick="importData()" title="–Ü–º–ø–æ—Ä—Ç">üì•</button>
        <button onclick="checkStorageInfo()" title="–°—Ö–æ–≤–∏—â–µ">üóÑÔ∏è</button>
        <button
          onclick="openSettingsModal()"
          id="settingsBtn"
          title="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–º–∏"
        >
          üé®
        </button>
      </div>
      <input
        type="file"
        id="importFile"
        accept=".json"
        style="display: none"
        onchange="handleImportFile(event)"
      />

      <div class="stats">
        <div class="stat-card">
          <span class="stat-number"
            ><span id="unlockedCount">0</span> /
            <span id="totalCount">0</span></span
          >
          <span class="stat-label">–í–∏–∫–æ–Ω–∞–Ω–æ –¥–æ—Å—è–≥–Ω–µ–Ω—å</span>
        </div>
      </div>

      <div class="categories" id="categoriesContainer"></div>
    </div>

    <div class="modal" id="achievementModal">
      <div class="modal-content">
        <div class="modal-icon" id="modalIcon">üéâ</div>
        <h2 id="modalTitle">–î–æ—Å—è–≥–Ω–µ–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏—Ç–æ!</h2>
        <p id="modalDescription"></p>
        <button onclick="closeModal()">–°—É–ø–µ—Ä!</button>
      </div>
    </div>

    <div class="modal" id="imageModal" onclick="closeImageModal()">
      <div class="image-modal-content">
        <img id="imageModalImg" src="" alt="–ü–æ–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä" />
      </div>
    </div>

    <div class="form-modal" id="formModal">
      <div class="form-content">
        <h2 id="formTitle">–î–æ–¥–∞—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</h2>
        <form id="achievementForm" onsubmit="saveAchievement(event)">
          <div class="form-group">
            <label for="categorySelect">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
            <select id="categorySelect" required>
              <option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>
            </select>
          </div>

          <div class="form-group">
            <label for="achievementName">–ù–∞–∑–≤–∞ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è</label>
            <input type="text" id="achievementName" required maxlength="50" />
          </div>

          <div class="form-group">
            <label for="achievementDescription">–û–ø–∏—Å (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
            <textarea id="achievementDescription" maxlength="100"></textarea>
          </div>

          <div class="form-group">
            <label>–Ü–∫–æ–Ω–∫–∞ –∞–±–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (–Ω–µ–æ–±–æ–≤'—è–∑–∫–æ–≤–æ)</label>
            <div
              class="image-upload-area"
              onclick="document.getElementById('imageUpload').click()"
            >
              <input
                type="file"
                id="imageUpload"
                accept="image/*"
                onchange="handleImageUpload(event)"
              />
              <div id="uploadContent">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">
                  –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è<br />–∞–±–æ –æ–±–µ—Ä—ñ—Ç—å –µ–º–æ–¥–∑—ñ
                  –Ω–∏–∂—á–µ
                </div>
              </div>
              <img
                id="previewImage"
                class="preview-image"
                style="display: none"
              />
            </div>
          </div>

          <div class="form-group">
            <label>–ê–±–æ –æ–±–µ—Ä—ñ—Ç—å –µ–º–æ–¥–∑—ñ</label>
            <div class="emoji-picker" id="emojiPicker"></div>
          </div>

          <input type="hidden" id="achievementId" />
          <input type="hidden" id="achievementImage" />
          <input type="hidden" id="editingCategory" />

          <div class="form-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeFormModal()"
            >
              –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
            <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          </div>
        </form>
      </div>
    </div>

    <div class="form-modal" id="categoryModal">
      <div class="form-content">
        <h2 id="categoryFormTitle">–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</h2>
        <form id="categoryForm" onsubmit="saveCategory(event)">
          <div class="form-group">
            <label for="categoryName">–ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
            <input
              type="text"
              id="categoryName"
              required
              maxlength="30"
              placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –•–æ–±—ñ, –ù–∞–≤—á–∞–Ω–Ω—è"
            />
          </div>

          <div class="form-group">
            <label>–Ü–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</label>
            <div
              class="image-upload-area"
              onclick="document.getElementById('categoryImageUpload').click()"
            >
              <input
                type="file"
                id="categoryImageUpload"
                accept="image/*"
                onchange="handleCategoryImageUpload(event)"
              />
              <div id="categoryUploadContent">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">
                  –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è<br />–∞–±–æ –æ–±–µ—Ä—ñ—Ç—å –µ–º–æ–¥–∑—ñ
                  –Ω–∏–∂—á–µ
                </div>
              </div>
              <img
                id="categoryPreviewImage"
                class="preview-image"
                style="display: none"
              />
            </div>
          </div>

          <div class="form-group">
            <label>–ê–±–æ –æ–±–µ—Ä—ñ—Ç—å –µ–º–æ–¥–∑—ñ</label>
            <div class="emoji-picker" id="categoryEmojiPicker"></div>
          </div>

          <input type="hidden" id="categoryKey" />
          <input type="hidden" id="categoryIcon" />

          <div class="form-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeCategoryModal()"
            >
              –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
            <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          </div>
        </form>
      </div>
    </div>

    <div class="form-modal" id="settingsModal">
      <div class="form-content">
        <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–µ–º–∏</h2>
        <form id="settingsForm" onsubmit="saveSettings(event)">
          <div class="form-group">
            <label for="themeColor1">–ö–æ–ª—ñ—Ä 1</label>
            <input type="color" id="themeColor1" value="#667eea" />
          </div>

          <div class="form-group">
            <label for="themeColor2">–ö–æ–ª—ñ—Ä 2</label>
            <input type="color" id="themeColor2" value="#764ba2" />
          </div>

          <div class="form-group">
            <label for="themeAngle">–ö—É—Ç –≥—Ä–∞–¥—ñ—î–Ω—Ç–∞ (¬∞)</label>
            <input
              type="number"
              id="themeAngle"
              min="0"
              max="360"
              value="135"
            />
          </div>

          <div class="form-group">
            <label>–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥</label>
            <div
              id="gradientPreview"
              style="
                height: 80px;
                border-radius: 8px;
                border: 1px solid #e0e0e0;
              "
            ></div>
          </div>

          <div class="form-buttons">
            <button
              type="button"
              class="btn btn-secondary"
              onclick="closeSettingsModal()"
            >
              –°–∫–∞—Å—É–≤–∞—Ç–∏
            </button>
            <button type="submit" class="btn btn-primary">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
          </div>
        </form>
      </div>
    </div>

    <div class="confirm-modal" id="confirmImportModal">
      <div class="confirm-content">
        <div class="confirm-icon">‚ö†Ô∏è</div>
        <h2>–Ü–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ?</h2>
        <p>–Ü–º–ø–æ—Ä—Ç –∑–∞–º—ñ–Ω–∏—Ç—å –≤—Å—ñ –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ.</p>
        <p>
          <strong
            >–†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è —Å–ø–æ—á–∞—Ç–∫—É –∑—Ä–æ–±–∏—Ç–∏ –µ–∫—Å–ø–æ—Ä—Ç –ø–æ—Ç–æ—á–Ω–∏—Ö –¥–∞–Ω–∏—Ö!</strong
          >
        </p>
        <div class="confirm-buttons">
          <button class="btn-cancel" onclick="closeConfirmImport()">
            –°–∫–∞—Å—É–≤–∞—Ç–∏
          </button>
          <button class="btn-confirm" onclick="confirmImport()">
            –¢–∞–∫, —ñ–º–ø–æ—Ä—Ç—É–≤–∞—Ç–∏
          </button>
        </div>
      </div>
    </div>

    <div class="confirm-modal" id="storageInfoModal">
      <div class="confirm-content">
        <div class="confirm-icon">üíæ</div>
        <h2>–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å—Ö–æ–≤–∏—â–∞</h2>
        <p id="storageInfoMessage"></p>
        <div class="confirm-buttons">
          <button class="btn-cancel" onclick="closeStorageInfo()">
            –ó–∞–∫—Ä–∏—Ç–∏
          </button>
        </div>
      </div>
    </div>

    <div class="confirm-modal" id="confirmResetModal">
      <div class="confirm-content">
        <div class="confirm-icon">‚ö†Ô∏è</div>
        <h2>–°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ?</h2>
        <p>
          –¶—è –¥—ñ—è –≤–∏–¥–∞–ª–∏—Ç—å –≤—Å—ñ –≤–∞—à—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è, –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó —Ç–∞ –ø—Ä–æ–≥—Ä–µ—Å. –ü—Ä–æ–≥—Ä–∞–º–∞
          –±—É–¥–µ –ø–æ–≤–µ—Ä–Ω–µ–Ω–∞ –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É.
        </p>
        <p><strong>–¶—é –¥—ñ—é –Ω–µ–º–æ–∂–ª–∏–≤–æ —Å–∫–∞—Å—É–≤–∞—Ç–∏!</strong></p>
        <div class="confirm-buttons">
          <button class="btn-cancel" onclick="closeConfirmReset()">
            –°–∫–∞—Å—É–≤–∞—Ç–∏
          </button>
          <button class="btn-confirm" onclick="confirmReset()">
            –¢–∞–∫, —Å–∫–∏–Ω—É—Ç–∏ –≤—Å–µ
          </button>
        </div>
      </div>
    </div>

    <div class="confirm-modal" id="confirmDeleteModal">
      <div class="confirm-content">
        <div class="confirm-icon">‚ö†Ô∏è</div>
        <h2 id="confirmDeleteTitle">–í–∏–¥–∞–ª–∏—Ç–∏?</h2>
        <p id="confirmDeleteMessage"></p>
        <div class="confirm-buttons">
          <button class="btn-cancel" onclick="closeConfirmDelete()">
            –°–∫–∞—Å—É–≤–∞—Ç–∏
          </button>
          <button class="btn-confirm" onclick="confirmDelete()">
            –¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏
          </button>
        </div>
      </div>
    </div>

    <button
      class="reset-btn"
      onclick="openConfirmReset()"
      title="–°–∫–∏–Ω—É—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ"
    >
      <span>üîÑ</span>
      <span>–°–∫–∏–Ω—É—Ç–∏ –≤—Å–µ</span>
    </button>

    <button
      class="add-achievement-btn"
      onclick="openAddModal()"
      title="–î–æ–¥–∞—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è"
    >
      +
    </button>

    <script>
      const emojis = [
        'üèÉ',
        'ü•ó',
        'üíß',
        'üßò',
        'üèãÔ∏è',
        'üí™',
        '‚öΩ',
        'üèä',
        'üö¥',
        'üéØ',
        'üìö',
        'üéì',
        'üíº',
        'üöÄ',
        'üí°',
        'üèÜ',
        'üéâ',
        'ü§ù',
        '‚ù§Ô∏è',
        'üé§',
        'üåç',
        '‚úàÔ∏è',
        'üèñÔ∏è',
        'üó∫Ô∏è',
        'üìñ',
        'üé®',
        'üéµ',
        'üé∏',
        'üé¨',
        'üì∑',
        'üå±',
        'üåª',
        'üåà',
        '‚≠ê',
        'üåü',
        'üí´',
        '‚ú®',
        'üí∞',
        'üíµ',
        'üìä',
        'üìà',
        'üè†',
        'üè°',
        'üíé',
        'üîë',
        'üéÅ',
        'üçï',
        'üçî',
        '‚òï',
        'üç∞',
        'üéÆ',
        'üé≤',
        'üé™',
        'üé≠',
        'üèîÔ∏è',
        'üåä',
        'üî•',
        '‚ùÑÔ∏è',
        'üå∏',
        'üéÑ',
        'üë•',
        'üéØ',
        'üì±',
        'üíª',
        'üñ•Ô∏è',
        '‚åö',
        'üéß',
        'üì∫',
        'üéπ',
        'üé∫',
      ];

      let achievements = {
        health: {
          title: "–ó–¥–æ—Ä–æ–≤'—è",
          icon: 'üí™',
          collapsed: true,
          order: 0,
          items: [
            {
              id: 1,
              icon: 'üèÉ',
              name: '–ü–µ—Ä—à–∏–π –∫—Ä–æ–∫',
              description: '–ü—Ä–æ–±—ñ–≥—Ç–∏ –ø–µ—Ä—à—ñ 5 –∫–º',
              points: 10,
              unlocked: false,
            },
            {
              id: 2,
              icon: 'ü•ó',
              name: '–ó–¥–æ—Ä–æ–≤–µ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è',
              description: '–¢–∏–∂–¥–µ–Ω—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ö–∞—Ä—á—É–≤–∞–Ω–Ω—è',
              points: 15,
              unlocked: false,
            },
            {
              id: 3,
              icon: 'üíß',
              name: '–í–æ–¥–Ω–∏–π –±–∞–ª–∞–Ω—Å',
              description: '–ü–∏—Ç–∏ 2–ª –≤–æ–¥–∏ —â–æ–¥–Ω—è –ø—Ä–æ—Ç—è–≥–æ–º –º—ñ—Å—è—Ü—è',
              points: 20,
              unlocked: false,
            },
            {
              id: 4,
              icon: 'üßò',
              name: 'Zen –º–∞–π—Å—Ç–µ—Ä',
              description: '30 –¥–Ω—ñ–≤ –º–µ–¥–∏—Ç–∞—Ü—ñ—ó –ø—ñ–¥—Ä—è–¥',
              points: 25,
              unlocked: false,
            },
            {
              id: 5,
              icon: 'üèãÔ∏è',
              name: '–°–∏–ª–∞—á',
              description: '3 –º—ñ—Å—è—Ü—ñ —Ä–µ–≥—É–ª—è—Ä–Ω–∏—Ö —Ç—Ä–µ–Ω—É–≤–∞–Ω—å',
              points: 30,
              unlocked: false,
            },
          ],
        },
        career: {
          title: "–ö–∞—Ä'—î—Ä–∞",
          icon: 'üíº',
          collapsed: true,
          order: 1,
          items: [
            {
              id: 6,
              icon: 'üìö',
              name: '–ü–µ—Ä—à–∏–π –Ω–∞–≤–∏–∫',
              description: '–í–∏–≤—á–∏—Ç–∏ –Ω–æ–≤—É —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—é',
              points: 15,
              unlocked: false,
            },
            {
              id: 7,
              icon: 'üéØ',
              name: '–ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è',
              description: '–û—Ç—Ä–∏–º–∞—Ç–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –Ω–∞ —Ä–æ–±–æ—Ç—ñ',
              points: 30,
              unlocked: false,
            },
            {
              id: 8,
              icon: 'üöÄ',
              name: '–°–≤—ñ–π –ø—Ä–æ—î–∫—Ç',
              description: '–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤–ª–∞—Å–Ω–∏–π –ø—Ä–æ—î–∫—Ç',
              points: 50,
              unlocked: false,
            },
            {
              id: 9,
              icon: 'üí°',
              name: '–Ü–Ω–Ω–æ–≤–∞—Ç–æ—Ä',
              description: '–†–µ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—É —ñ–¥–µ—é',
              points: 25,
              unlocked: false,
            },
            {
              id: 10,
              icon: 'üèÜ',
              name: '–ü—Ä–æ—Ñ–µ—Å—ñ–æ–Ω–∞–ª',
              description: '5 —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É –≤ –≥–∞–ª—É–∑—ñ',
              points: 100,
              unlocked: false,
            },
          ],
        },
        social: {
          title: '–°–æ—Ü—ñ–∞–ª—å–Ω–µ –∂–∏—Ç—Ç—è',
          icon: 'üë•',
          collapsed: true,
          order: 2,
          items: [
            {
              id: 11,
              icon: 'üéâ',
              name: '–û—Ä–≥–∞–Ω—ñ–∑–∞—Ç–æ—Ä',
              description: '–û—Ä–≥–∞–Ω—ñ–∑—É–≤–∞—Ç–∏ –∑–∞—Ö—ñ–¥ –¥–ª—è –¥—Ä—É–∑—ñ–≤',
              points: 15,
              unlocked: false,
            },
            {
              id: 12,
              icon: 'ü§ù',
              name: '–ù–æ–≤—ñ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞',
              description: '–ü–æ–∑–Ω–∞–π–æ–º–∏—Ç–∏—Å—è –∑ 10 –Ω–æ–≤–∏–º–∏ –ª—é–¥—å–º–∏',
              points: 20,
              unlocked: false,
            },
            {
              id: 13,
              icon: '‚ù§Ô∏è',
              name: '–î–æ–≤–≥–æ—Å—Ç—Ä–æ–∫–æ–≤—ñ –≤—ñ–¥–Ω–æ—Å–∏–Ω–∏',
              description: '–†—ñ–∫ —É –≤—ñ–¥–Ω–æ—Å–∏–Ω–∞—Ö',
              points: 30,
              unlocked: false,
            },
            {
              id: 14,
              icon: 'üé§',
              name: '–ü—É–±–ª—ñ—á–Ω–∏–π –≤–∏—Å—Ç—É–ø',
              description: '–í–∏—Å—Ç—É–ø–∏—Ç–∏ –ø–µ—Ä–µ–¥ –∞—É–¥–∏—Ç–æ—Ä—ñ—î—é',
              points: 25,
              unlocked: false,
            },
            {
              id: 15,
              icon: 'üåç',
              name: '–ú–∞–Ω–¥—Ä—ñ–≤–Ω–∏–∫',
              description: '–í—ñ–¥–≤—ñ–¥–∞—Ç–∏ 5 –Ω–æ–≤–∏—Ö –∫—Ä–∞—ó–Ω',
              points: 40,
              unlocked: false,
            },
          ],
        },
        personal: {
          title: '–û—Å–æ–±–∏—Å—Ç–∏–π —Ä–æ–∑–≤–∏—Ç–æ–∫',
          icon: 'üåü',
          collapsed: true,
          order: 3,
          items: [
            {
              id: 16,
              icon: 'üìñ',
              name: '–ö–Ω–∏–≥–æ–ª—é–±',
              description: '–ü—Ä–æ—á–∏—Ç–∞—Ç–∏ 12 –∫–Ω–∏–≥ –∑–∞ —Ä—ñ–∫',
              points: 20,
              unlocked: false,
            },
            {
              id: 17,
              icon: 'üé®',
              name: '–¢–≤–æ—Ä–µ—Ü—å',
              description: '–°—Ç–≤–æ—Ä–∏—Ç–∏ —â–æ—Å—å —Å–≤–æ—ó–º–∏ —Ä—É–∫–∞–º–∏',
              points: 15,
              unlocked: false,
            },
            {
              id: 18,
              icon: 'üéµ',
              name: '–ú—É–∑–∏–∫–∞–Ω—Ç',
              description: '–ù–∞–≤—á–∏—Ç–∏—Å—è –≥—Ä–∞—Ç–∏ –Ω–∞ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ',
              points: 35,
              unlocked: false,
            },
            {
              id: 19,
              icon: 'üå±',
              name: '–ù–æ–≤–∞ –∑–≤–∏—á–∫–∞',
              description: '–°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å–Ω—É –∑–≤–∏—á–∫—É (21 –¥–µ–Ω—å)',
              points: 20,
              unlocked: false,
            },
            {
              id: 20,
              icon: 'üéì',
              name: '–í—ñ—á–Ω–∏–π —Å—Ç—É–¥–µ–Ω—Ç',
              description: '–ü—Ä–æ–π—Ç–∏ –æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å',
              points: 25,
              unlocked: false,
            },
          ],
        },
        finance: {
          title: '–§—ñ–Ω–∞–Ω—Å–∏',
          icon: 'üí∞',
          collapsed: true,
          order: 4,
          items: [
            {
              id: 21,
              icon: 'üíµ',
              name: '–ü–µ—Ä—à—ñ –∑–∞–æ—â–∞–¥–∂–µ–Ω–Ω—è',
              description: '–ù–∞–∫–æ–ø–∏—á–∏—Ç–∏ –º—ñ—Å—è—á–Ω—É –∑–∞—Ä–ø–ª–∞—Ç—É',
              points: 20,
              unlocked: false,
            },
            {
              id: 22,
              icon: 'üìä',
              name: '–Ü–Ω–≤–µ—Å—Ç–æ—Ä',
              description: '–ó—Ä–æ–±–∏—Ç–∏ –ø–µ—Ä—à—ñ —ñ–Ω–≤–µ—Å—Ç–∏—Ü—ñ—ó',
              points: 30,
              unlocked: false,
            },
            {
              id: 23,
              icon: 'üè†',
              name: '–í–ª–∞—Å–Ω–µ –∂–∏—Ç–ª–æ',
              description: '–ö—É–ø–∏—Ç–∏ –∫–≤–∞—Ä—Ç–∏—Ä—É/–±—É–¥–∏–Ω–æ–∫',
              points: 100,
              unlocked: false,
            },
            {
              id: 24,
              icon: 'üìà',
              name: '–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –≥—Ä–∞–º–æ—Ç–Ω—ñ—Å—Ç—å',
              description: '–í–µ—Å—Ç–∏ –±—é–¥–∂–µ—Ç –ø—Ä–æ—Ç—è–≥–æ–º —Ä–æ–∫—É',
              points: 25,
              unlocked: false,
            },
            {
              id: 25,
              icon: 'üíé',
              name: '–§—ñ–Ω–∞–Ω—Å–æ–≤–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω—ñ—Å—Ç—å',
              description: '–ü–∞—Å–∏–≤–Ω–∏–π –¥–æ—Ö—ñ–¥ > –≤–∏—Ç—Ä–∞—Ç',
              points: 150,
              unlocked: false,
            },
          ],
        },
      };

      let nextId = 26;
      let editMode = false;
      let pendingDeleteAction = null;

      let settings = {
        color1: '#667eea',
        color2: '#764ba2',
        angle: 135,
        useGradient: true,
      };

      function applySettings() {
        try {
          if (settings && settings.useGradient) {
            const grad = `linear-gradient(${settings.angle}deg, ${settings.color1} 0%, ${settings.color2} 100%)`;
            document.documentElement.style.setProperty('--app-gradient', grad);
          } else {
            document.documentElement.style.removeProperty('--app-gradient');
          }
        } catch (e) {
          console.error('Error applying settings', e);
        }
      }

      // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
      function toggleEditMode() {
        editMode = !editMode;
        const btn = document.getElementById('editModeBtn');
        const container = document.getElementById('categoriesContainer');
        const body = document.body;
        const extraButtons = document.getElementById('extraButtons');

        if (editMode) {
          btn.classList.add('active');
          btn.textContent = '‚úì';
          container.classList.add('edit-mode');
          body.classList.add('edit-mode');
          extraButtons.style.display = 'flex';
        } else {
          btn.classList.remove('active');
          btn.textContent = '‚öôÔ∏è';
          container.classList.remove('edit-mode');
          body.classList.remove('edit-mode');
          extraButtons.style.display = 'none';
        }
      }

      // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∑ localStorage
      function loadProgress() {
        const saved = localStorage.getItem('lifeAchievements');
        if (saved) {
          const savedData = JSON.parse(saved);
          achievements = savedData.achievements || achievements;
          nextId = savedData.nextId || nextId;
          if (savedData.settings) {
            settings = Object.assign({}, settings, savedData.settings);
          }
        }
      }

      // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
      function saveProgress() {
        try {
          const dataToSave = JSON.stringify({
            achievements: achievements,
            nextId: nextId,
            settings: settings,
          });

          localStorage.setItem('lifeAchievements', dataToSave);

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è localStorage
          checkStorageUsage();
        } catch (e) {
          if (
            e.name === 'QuotaExceededError' ||
            e.name === 'NS_ERROR_DOM_QUOTA_REACHED'
          ) {
            alert(
              '‚ö†Ô∏è –£–í–ê–ì–ê: –°—Ö–æ–≤–∏—â–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–µ!\n\n–î–∞–Ω—ñ –Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–æ. –ï–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ —Å–≤–æ—ó –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è (–∫–Ω–æ–ø–∫–∞ "üíæ –ï–∫—Å–ø–æ—Ä—Ç"), —â–æ–± –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ —ó—Ö.\n\n–ü–æ—Ä–∞–¥–∞: –í–∏–¥–∞–ª—ñ—Ç—å —Å—Ç–∞—Ä—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∞–±–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –º–µ–Ω—à—ñ —Ñ–æ—Ç–æ.',
            );
            console.error('localStorage quota exceeded');
          } else {
            console.error('Error saving to localStorage:', e);
            alert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö: ' + e.message);
          }
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ —Å—Ö–æ–≤–∏—â–µ
      function checkStorageInfo() {
        try {
          let total = 0;
          for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
              total += localStorage[key].length + key.length;
            }
          }

          const usedMB = (total / 1024 / 1024).toFixed(2);
          const usedKB = (total / 1024).toFixed(0);
          const limitMB = 5;
          const percentage = ((usedMB / limitMB) * 100).toFixed(1);

          let status = '';
          let icon = '';
          if (percentage < 50) {
            status = '‚úÖ –î–æ—Å—Ç–∞—Ç–Ω—å–æ –º—ñ—Å—Ü—è';
            icon = '‚úÖ';
          } else if (percentage < 70) {
            status = '‚ö†Ô∏è –ü–æ–º—ñ—Ä–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è';
            icon = '‚ö†Ô∏è';
          } else if (percentage < 90) {
            status = '‚ö†Ô∏è –í–∏—Å–æ–∫–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è';
            icon = '‚ö†Ô∏è';
          } else {
            status = 'üö® –ö–†–ò–¢–ò–ß–ù–û!';
            icon = 'üö®';
          }

          const message = `
                    ${icon} ${status}
                    
                    –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: ${usedMB} MB (${usedKB} KB)
                    –õ—ñ–º—ñ—Ç: ~${limitMB} MB
                    –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è: ${percentage}%
                    
                    ${percentage > 70 ? '\n‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –∑—Ä–æ–±–∏—Ç–∏ –µ–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö!' : ''}
                    ${percentage > 90 ? '\nüö® –¢–ï–†–ú–Ü–ù–û–í–û –µ–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ –¥–∞–Ω—ñ!' : ''}
                `;

          document.getElementById('storageInfoMessage').textContent = message;
          document.getElementById('storageInfoModal').classList.add('active');
        } catch (e) {
          alert('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ö–æ–≤–∏—â–∞: ' + e.message);
        }
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ –≤—ñ–∫–Ω–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ —Å—Ö–æ–≤–∏—â–µ
      function closeStorageInfo() {
        document.getElementById('storageInfoModal').classList.remove('active');
      }

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Å—Ö–æ–≤–∏—â–∞
      function checkStorageUsage() {
        try {
          let total = 0;
          for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
              total += localStorage[key].length + key.length;
            }
          }

          // –ü–µ—Ä–µ–≤–æ–¥–∏–º–æ –≤ MB
          const usedMB = (total / 1024 / 1024).toFixed(2);
          const limitMB = 5; // –ü—Ä–∏–±–ª–∏–∑–Ω–∏–π –ª—ñ–º—ñ—Ç –¥–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ –±—Ä–∞—É–∑–µ—Ä—ñ–≤
          const percentage = ((usedMB / limitMB) * 100).toFixed(1);

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è (–±–µ–∑ –≤–∏–≤–æ–¥—É –≤ –∫–æ–Ω—Å–æ–ª—å)

          // –ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ 70% –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è
          if (percentage > 70 && percentage <= 90) {
            showStorageWarning('medium', usedMB, percentage);
          } else if (percentage > 90) {
            showStorageWarning('high', usedMB, percentage);
          }
        } catch (e) {
          console.error('Error checking storage:', e);
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è –ø—Ä–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Å—Ö–æ–≤–∏—â–∞
      function showStorageWarning(level, usedMB, percentage) {
        const warningId = 'storage-warning-' + level;

        // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ —Ä–∞–∑ –∑–∞ —Å–µ—Å—ñ—é
        if (sessionStorage.getItem(warningId)) {
          return;
        }

        let message = '';
        if (level === 'medium') {
          message = `‚ö†Ô∏è –°—Ö–æ–≤–∏—â–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ –Ω–∞ ${percentage}%\n\n–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: ${usedMB} MB –∑ ~5 MB\n\n–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—è: –ó—Ä–æ–±—ñ—Ç—å –µ–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ—ó –∫–æ–ø—ñ—ó.`;
        } else if (level === 'high') {
          message = `üö® –£–í–ê–ì–ê! –°—Ö–æ–≤–∏—â–µ –º–∞–π–∂–µ –ø–µ—Ä–µ–ø–æ–≤–Ω–µ–Ω–µ!\n\n–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ: ${usedMB} MB –∑ ~5 MB (${percentage}%)\n\n–¢–ï–†–ú–Ü–ù–û–í–û: –ï–∫—Å–ø–æ—Ä—Ç—É–π—Ç–µ –¥–∞–Ω—ñ –∑–∞—Ä–∞–∑, —â–æ–± –Ω–µ –≤—Ç—Ä–∞—Ç–∏—Ç–∏ —ó—Ö!`;
        }

        if (message) {
          alert(message);
          sessionStorage.setItem(warningId, 'shown');
        }
      }

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –µ–º–æ–¥–∑—ñ-–ø—ñ–∫–µ—Ä–∞
      function initEmojiPicker() {
        const emojiPicker = document.getElementById('emojiPicker');
        emojiPicker.innerHTML = '';
        emojis.forEach((emoji) => {
          const emojiDiv = document.createElement('div');
          emojiDiv.className = 'emoji-option';
          emojiDiv.textContent = emoji;
          emojiDiv.onclick = (e) => {
            e.stopPropagation();
            selectEmoji(emoji);
          };
          emojiPicker.appendChild(emojiDiv);
        });
      }

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –µ–º–æ–¥–∑—ñ-–ø—ñ–∫–µ—Ä–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
      function initCategoryEmojiPicker() {
        const emojiPicker = document.getElementById('categoryEmojiPicker');
        emojiPicker.innerHTML = '';
        emojis.forEach((emoji) => {
          const emojiDiv = document.createElement('div');
          emojiDiv.className = 'emoji-option';
          emojiDiv.textContent = emoji;
          emojiDiv.onclick = (e) => {
            e.stopPropagation();
            selectCategoryEmoji(emoji);
          };
          emojiPicker.appendChild(emojiDiv);
        });
      }

      // –í–∏–±—ñ—Ä –µ–º–æ–¥–∑—ñ
      function selectEmoji(emoji) {
        document.getElementById('achievementImage').value = emoji;
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('uploadContent').innerHTML = `
                <div style="font-size: 4em; margin: 20px 0;">${emoji}</div>
                <div class="upload-text">–û–±—Ä–∞–Ω–æ –µ–º–æ–¥–∑—ñ (–Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –∑–º—ñ–Ω–∏)</div>
            `;
      }

      // –í–∏–±—ñ—Ä –µ–º–æ–¥–∑—ñ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
      function selectCategoryEmoji(emoji) {
        document.getElementById('categoryIcon').value = emoji;
        document.getElementById('categoryPreviewImage').style.display = 'none';
        document.getElementById('categoryUploadContent').innerHTML = `
                <div style="font-size: 4em; margin: 20px 0;">${emoji}</div>
                <div class="upload-text">–û–±—Ä–∞–Ω–æ –µ–º–æ–¥–∑—ñ (–Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –∑–º—ñ–Ω–∏)</div>
            `;
      }

      // –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      function handleImageUpload(event) {
        const file = event.target.files[0];

        if (!file) {
          alert('–§–∞–π–ª –Ω–µ –æ–±—Ä–∞–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
          return;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É (–º–∞–∫—Å–∏–º—É–º 5MB –¥–ª—è –∫–∞–º–µ—Ä–∏)
        if (file.size > 5 * 1024 * 1024) {
          alert(
            '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ. –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –º–µ–Ω—à–µ 5MB.',
          );
          return;
        }

        if (file.size === 0) {
          alert('–§–∞–π–ª –ø–æ—Ä–æ–∂–Ω—ñ–π. –°–ø—Ä–æ–±—É–π—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ —â–µ —Ä–∞–∑.');
          return;
        }

        const reader = new FileReader();

        reader.onerror = function (error) {
          console.error('ERROR: FileReader error:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π —Ñ–∞–π–ª.');
        };

        reader.onload = function (e) {
          try {
            const imageData = e.target.result;

            if (!imageData) {
              alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.');
              return;
            }

            const img = new Image();

            img.onload = function () {
              try {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                const maxSize = 400;
                if (width > maxSize || height > maxSize) {
                  if (width > height) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                  } else {
                    width = (width / height) * maxSize;
                    height = maxSize;
                  }
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                let compressedData;
                if (
                  file.type === 'image/png' ||
                  file.type === 'image/gif' ||
                  file.type === 'image/webp'
                ) {
                  compressedData = canvas.toDataURL('image/png');
                } else {
                  compressedData = canvas.toDataURL('image/jpeg', 0.8);
                }

                document.getElementById('achievementImage').value =
                  compressedData;
                document.getElementById('previewImage').src = compressedData;
                document.getElementById('previewImage').style.display = 'block';
                document.getElementById('uploadContent').style.display = 'none';
              } catch (error) {
                console.error('ERROR in canvas processing:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ' + error.message);
              }
            };

            img.onerror = function (error) {
              console.error('ERROR: Image failed to load');
              alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π —Ñ–∞–π–ª.');
            };

            img.src = imageData;
          } catch (error) {
            console.error('ERROR in onload handler:', error);
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ' + error.message);
          }
        };

        try {
          reader.readAsDataURL(file);
        } catch (error) {
          console.error('ERROR calling readAsDataURL:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ —Ñ–∞–π–ª—É: ' + error.message);
        }
      }

      // –û–±—Ä–æ–±–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
      function handleCategoryImageUpload(event) {
        const file = event.target.files[0];

        if (!file) {
          alert('–§–∞–π–ª –Ω–µ –æ–±—Ä–∞–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
          return;
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ä–æ–∑–º—ñ—Ä—É —Ñ–∞–π–ª—É (–º–∞–∫—Å–∏–º—É–º 5MB –¥–ª—è –∫–∞–º–µ—Ä–∏)
        if (file.size > 5 * 1024 * 1024) {
          alert(
            '–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑–∞–Ω–∞–¥—Ç–æ –≤–µ–ª–∏–∫–µ. –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –º–µ–Ω—à–µ 5MB.',
          );
          return;
        }

        if (file.size === 0) {
          alert('–§–∞–π–ª –ø–æ—Ä–æ–∂–Ω—ñ–π. –°–ø—Ä–æ–±—É–π—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ —â–µ —Ä–∞–∑.');
          return;
        }

        const reader = new FileReader();

        reader.onerror = function (error) {
          console.error('ERROR: FileReader error:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π —Ñ–∞–π–ª.');
        };

        reader.onload = function (e) {
          try {
            const imageData = e.target.result;

            if (!imageData) {
              alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è.');
              return;
            }

            const img = new Image();

            img.onload = function () {
              try {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                const maxSize = 400;
                if (width > maxSize || height > maxSize) {
                  if (width > height) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                  } else {
                    width = (width / height) * maxSize;
                    height = maxSize;
                  }
                }

                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                let compressedData;
                if (
                  file.type === 'image/png' ||
                  file.type === 'image/gif' ||
                  file.type === 'image/webp'
                ) {
                  compressedData = canvas.toDataURL('image/png');
                } else {
                  compressedData = canvas.toDataURL('image/jpeg', 0.8);
                }

                document.getElementById('categoryIcon').value = compressedData;
                document.getElementById('categoryPreviewImage').src =
                  compressedData;
                document.getElementById('categoryPreviewImage').style.display =
                  'block';
                document.getElementById('categoryUploadContent').style.display =
                  'none';
              } catch (error) {
                console.error('ERROR in canvas processing:', error);
                alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ' + error.message);
              }
            };

            img.onerror = function (error) {
              console.error('ERROR: Image failed to load');
              alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —ñ–Ω—à–∏–π —Ñ–∞–π–ª.');
            };

            img.src = imageData;
          } catch (error) {
            console.error('ERROR in onload handler:', error);
            alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è: ' + error.message);
          }
        };

        try {
          reader.readAsDataURL(file);
        } catch (error) {
          console.error('ERROR calling readAsDataURL:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —á–∏—Ç–∞–Ω–Ω—ñ —Ñ–∞–π–ª—É: ' + error.message);
        }
      }

      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
      function updateCategorySelect() {
        const select = document.getElementById('categorySelect');
        select.innerHTML = '<option value="">–û–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é</option>';
        Object.keys(achievements).forEach((key) => {
          const option = document.createElement('option');
          option.value = key;
          option.textContent = achievements[key].title;
          select.appendChild(option);
        });
      }

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
      function openAddModal() {
        document.getElementById('formTitle').textContent = '–î–æ–¥–∞—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è';
        document.getElementById('achievementForm').reset();
        document.getElementById('achievementId').value = '';
        document.getElementById('editingCategory').value = '';
        document.getElementById('achievementImage').value = '';
        document.getElementById('previewImage').style.display = 'none';
        document.getElementById('previewImage').src = '';
        document.getElementById('uploadContent').style.display = 'block';
        document.getElementById('uploadContent').innerHTML = `
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è<br>–∞–±–æ –æ–±–µ—Ä—ñ—Ç—å –µ–º–æ–¥–∑—ñ –Ω–∏–∂—á–µ</div>
            `;
        updateCategorySelect();

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–±–∏—Ä–∞—î–º–æ –ø–µ—Ä—à—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
        const categorySelect = document.getElementById('categorySelect');
        if (categorySelect.options.length > 0) {
          categorySelect.selectedIndex = 0;
        }

        initEmojiPicker();
        document.getElementById('formModal').classList.add('active');
      }

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
      function openEditModal(categoryKey, achievementId) {
        const category = achievements[categoryKey];
        const achievement = category.items.find((a) => a.id === achievementId);

        if (achievement) {
          document.getElementById('formTitle').textContent =
            '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è';

          // –°–ø–æ—á–∞—Ç–∫—É –æ–Ω–æ–≤–ª—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
          updateCategorySelect();

          // –ü–æ—Ç—ñ–º –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Ç–æ—á–Ω—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
          document.getElementById('categorySelect').value = categoryKey;
          document.getElementById('achievementName').value = achievement.name;
          document.getElementById('achievementDescription').value =
            achievement.description || '';
          document.getElementById('achievementId').value = achievement.id;
          document.getElementById('editingCategory').value = categoryKey;
          document.getElementById('achievementImage').value =
            achievement.image || achievement.icon || '';

          // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó —ñ–∫–æ–Ω–∫–∏/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          if (achievement.image && achievement.image.startsWith('data:')) {
            document.getElementById('previewImage').src = achievement.image;
            document.getElementById('previewImage').style.display = 'block';
            document.getElementById('uploadContent').style.display = 'none';
          } else if (achievement.icon) {
            document.getElementById('uploadContent').innerHTML = `
                        <div style="font-size: 4em; margin: 20px 0;">${achievement.icon}</div>
                        <div class="upload-text">–ü–æ—Ç–æ—á–Ω–∞ —ñ–∫–æ–Ω–∫–∞ (–Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –∑–º—ñ–Ω–∏)</div>
                    `;
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('previewImage').style.display = 'none';
          } else {
            document.getElementById('uploadContent').innerHTML = `
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">–ù–µ–º–∞—î —ñ–∫–æ–Ω–∫–∏ (–Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è)</div>
                    `;
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('previewImage').style.display = 'none';
          }

          initEmojiPicker();
          document.getElementById('formModal').classList.add('active');
        }
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ —Ñ–æ—Ä–º—É –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
      function closeFormModal() {
        document.getElementById('formModal').classList.remove('active');
      }

      // –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
      function saveAchievement(event) {
        event.preventDefault();

        const categoryKey = document.getElementById('categorySelect').value;
        const name = document.getElementById('achievementName').value;
        const description =
          document.getElementById('achievementDescription').value || '';
        const achievementId = document.getElementById('achievementId').value;
        const editingCategory =
          document.getElementById('editingCategory').value;
        const image = document.getElementById('achievementImage').value;

        if (!categoryKey) {
          alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫–∞—Ç–µ–≥–æ—Ä—ñ—é');
          return;
        }

        if (achievementId) {
          // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ–≥–æ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
          const oldCategory = achievements[editingCategory];
          const achievementIndex = oldCategory.items.findIndex(
            (a) => a.id === parseInt(achievementId),
          );

          if (achievementIndex !== -1) {
            const achievement = oldCategory.items[achievementIndex];

            // –Ø–∫—â–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è –∑–º—ñ–Ω–∏–ª–∞—Å—è, –ø–µ—Ä–µ–º—ñ—â—É—î–º–æ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
            if (editingCategory !== categoryKey) {
              oldCategory.items.splice(achievementIndex, 1);
              achievements[categoryKey].items.push({
                id: achievement.id,
                icon: image && !image.startsWith('data:') ? image : '',
                image: image && image.startsWith('data:') ? image : '',
                name: name,
                description: description,
                unlocked: achievement.unlocked,
              });
            } else {
              // –û–Ω–æ–≤–ª—é—î–º–æ –≤ —Ç—ñ–π –∂–µ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
              achievement.name = name;
              achievement.description = description;
              if (image) {
                if (image.startsWith('data:')) {
                  achievement.image = image;
                  achievement.icon = '';
                } else {
                  achievement.icon = image;
                  achievement.image = '';
                }
              } else {
                achievement.icon = '';
                achievement.image = '';
              }
            }
          }
        } else {
          // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
          const newAchievement = {
            id: nextId++,
            icon: image && !image.startsWith('data:') ? image : '',
            image: image && image.startsWith('data:') ? image : '',
            name: name,
            description: description,
            unlocked: false,
          };

          achievements[categoryKey].items.push(newAchievement);
        }

        saveProgress();
        closeFormModal();
        renderAchievements();
      }

      // –í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
      function deleteAchievement(categoryKey, achievementId) {
        const category = achievements[categoryKey];
        const achievement = category.items.find((a) => a.id === achievementId);

        document.getElementById('confirmDeleteTitle').textContent =
          '–í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è?';
        document.getElementById('confirmDeleteMessage').textContent =
          `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ "${achievement.name}"?`;

        pendingDeleteAction = () => {
          const index = category.items.findIndex((a) => a.id === achievementId);

          if (index !== -1) {
            category.items.splice(index, 1);
            saveProgress();
            renderAchievements();
          }
        };

        document.getElementById('confirmDeleteModal').classList.add('active');
      }

      // === –ö–ê–¢–ï–ì–û–†–Ü–á ===

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
      function openCategoryModal() {
        document.getElementById('categoryFormTitle').textContent =
          '–î–æ–¥–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é';
        document.getElementById('categoryForm').reset();
        document.getElementById('categoryKey').value = '';
        document.getElementById('categoryIcon').value = '';
        document.getElementById('categoryPreviewImage').style.display = 'none';
        document.getElementById('categoryPreviewImage').src = '';
        document.getElementById('categoryUploadContent').style.display =
          'block';
        document.getElementById('categoryUploadContent').innerHTML = `
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è<br>–∞–±–æ –æ–±–µ—Ä—ñ—Ç—å –µ–º–æ–¥–∑—ñ –Ω–∏–∂—á–µ</div>
            `;
        initCategoryEmojiPicker();
        document.getElementById('categoryModal').classList.add('active');
      }

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
      function openEditCategoryModal(categoryKey) {
        const category = achievements[categoryKey];

        if (category) {
          document.getElementById('categoryFormTitle').textContent =
            '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é';
          document.getElementById('categoryName').value = category.title;
          document.getElementById('categoryKey').value = categoryKey;
          document.getElementById('categoryIcon').value = category.icon;

          // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó —ñ–∫–æ–Ω–∫–∏/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
          if (category.icon && category.icon.startsWith('data:')) {
            document.getElementById('categoryPreviewImage').src = category.icon;
            document.getElementById('categoryPreviewImage').style.display =
              'block';
            document.getElementById('categoryUploadContent').style.display =
              'none';
          } else {
            document.getElementById('categoryUploadContent').innerHTML = `
                        <div style="font-size: 4em; margin: 20px 0;">${category.icon}</div>
                        <div class="upload-text">–ü–æ—Ç–æ—á–Ω–∞ —ñ–∫–æ–Ω–∫–∞ (–Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –∑–º—ñ–Ω–∏)</div>
                    `;
            document.getElementById('categoryUploadContent').style.display =
              'block';
            document.getElementById('categoryPreviewImage').style.display =
              'none';
          }

          initCategoryEmojiPicker();
          document.getElementById('categoryModal').classList.add('active');
        }
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ —Ñ–æ—Ä–º—É –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
      function closeCategoryModal() {
        document.getElementById('categoryModal').classList.remove('active');
      }

      // –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
      function saveCategory(event) {
        event.preventDefault();

        const categoryName = document.getElementById('categoryName').value;
        const categoryKey = document.getElementById('categoryKey').value;
        const categoryIcon = document.getElementById('categoryIcon').value;

        if (!categoryIcon) {
          alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —ñ–∫–æ–Ω–∫—É –∞–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è');
          return;
        }

        if (categoryKey) {
          // –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ—Å–Ω—É—é—á–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
          if (achievements[categoryKey]) {
            achievements[categoryKey].title = categoryName;
            achievements[categoryKey].icon = categoryIcon;
          }
        } else {
          // –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
          const newKey = categoryName
            .toLowerCase()
            .replace(/[^a-z0-9–∞-—è]/g, '_');

          if (achievements[newKey]) {
            alert('–ö–∞—Ç–µ–≥–æ—Ä—ñ—è –∑ —Ç–∞–∫–æ—é –Ω–∞–∑–≤–æ—é –≤–∂–µ —ñ—Å–Ω—É—î');
            return;
          }

          // –í–∏–∑–Ω–∞—á–∞—î–º–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π order
          const maxOrder = Math.max(
            ...Object.values(achievements).map((c) => c.order || 0),
            -1,
          );

          achievements[newKey] = {
            title: categoryName,
            icon: categoryIcon,
            collapsed: true,
            order: maxOrder + 1,
            items: [],
          };
        }

        saveProgress();
        closeCategoryModal();
        renderAchievements();
      }

      // –í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é
      function deleteCategory(categoryKey) {
        const category = achievements[categoryKey];
        const hasAchievements = category.items.length > 0;

        document.getElementById('confirmDeleteTitle').textContent =
          '–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é?';

        let message = `–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é "${category.title}"?`;
        if (hasAchievements) {
          message = `–ö–∞—Ç–µ–≥–æ—Ä—ñ—è "${category.title}" –º—ñ—Å—Ç–∏—Ç—å ${category.items.length} –¥–æ—Å—è–≥–Ω–µ–Ω—å. –í—Å—ñ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?`;
        }

        document.getElementById('confirmDeleteMessage').textContent = message;

        pendingDeleteAction = () => {
          delete achievements[categoryKey];
          saveProgress();
          renderAchievements();
        };

        document.getElementById('confirmDeleteModal').classList.add('active');
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è
      function closeConfirmDelete() {
        document
          .getElementById('confirmDeleteModal')
          .classList.remove('active');
        pendingDeleteAction = null;
      }

      // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
      function confirmDelete() {
        if (pendingDeleteAction) {
          pendingDeleteAction();
          pendingDeleteAction = null;
        }
        closeConfirmDelete();
      }

      // === –°–û–†–¢–£–í–ê–ù–ù–Ø ===

      // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑–∞ –ø–æ—Ä—è–¥–∫–æ–º
      function getSortedCategoryKeys() {
        return Object.keys(achievements).sort((a, b) => {
          const orderA =
            achievements[a].order !== undefined ? achievements[a].order : 999;
          const orderB =
            achievements[b].order !== undefined ? achievements[b].order : 999;
          return orderA - orderB;
        });
      }

      // –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤–≥–æ—Ä—É
      function moveCategoryUp(categoryKey) {
        const sortedKeys = getSortedCategoryKeys();
        const currentIndex = sortedKeys.indexOf(categoryKey);

        if (currentIndex > 0) {
          const prevKey = sortedKeys[currentIndex - 1];
          const temp = achievements[categoryKey].order;
          achievements[categoryKey].order = achievements[prevKey].order;
          achievements[prevKey].order = temp;

          saveProgress();
          renderAchievements();
        }
      }

      // –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –≤–Ω–∏–∑
      function moveCategoryDown(categoryKey) {
        const sortedKeys = getSortedCategoryKeys();
        const currentIndex = sortedKeys.indexOf(categoryKey);

        if (currentIndex < sortedKeys.length - 1) {
          const nextKey = sortedKeys[currentIndex + 1];
          const temp = achievements[categoryKey].order;
          achievements[categoryKey].order = achievements[nextKey].order;
          achievements[nextKey].order = temp;

          saveProgress();
          renderAchievements();
        }
      }

      // –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –≤–≥–æ—Ä—É
      function moveAchievementUp(categoryKey, achievementId) {
        const category = achievements[categoryKey];
        const index = category.items.findIndex((a) => a.id === achievementId);

        if (index > 0) {
          const temp = category.items[index];
          category.items[index] = category.items[index - 1];
          category.items[index - 1] = temp;

          saveProgress();
          renderAchievements();
        }
      }

      // –ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è –≤–Ω–∏–∑
      function moveAchievementDown(categoryKey, achievementId) {
        const category = achievements[categoryKey];
        const index = category.items.findIndex((a) => a.id === achievementId);

        if (index < category.items.length - 1) {
          const temp = category.items[index];
          category.items[index] = category.items[index + 1];
          category.items[index + 1] = temp;

          saveProgress();
          renderAchievements();
        }
      }

      // –ü–µ—Ä–µ–º—ñ–∫–∞–Ω–Ω—è –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
      function toggleCategoryCollapse(categoryKey) {
        achievements[categoryKey].collapsed =
          !achievements[categoryKey].collapsed;
        saveProgress();
        renderAchievements();
      }

      // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —Ç–∞ –¥–æ—Å—è–≥–Ω–µ–Ω—å
      function renderAchievements() {
        const container = document.getElementById('categoriesContainer');
        container.innerHTML = '';

        const sortedKeys = getSortedCategoryKeys();

        sortedKeys.forEach((categoryKey, catIndex) => {
          const category = achievements[categoryKey];
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'category';
          if (category.collapsed) {
            categoryDiv.classList.add('collapsed');
          }

          // –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
          const categoryHeader = document.createElement('div');
          categoryHeader.className = 'category-header';

          // –ü–µ—Ä—à–∏–π —Ä—è–¥ - –∫–Ω–æ–ø–∫–∞ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è, —ñ–∫–æ–Ω–∫–∞ —Ç–∞ –Ω–∞–∑–≤–∞
          const categoryHeaderTop = document.createElement('div');
          categoryHeaderTop.className = 'category-header-top';
          categoryHeaderTop.onclick = () => toggleCategoryCollapse(categoryKey);

          // –ö–Ω–æ–ø–∫–∞ –∑–≥–æ—Ä—Ç–∞–Ω–Ω—è/—Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è
          const collapseBtn = document.createElement('button');
          collapseBtn.className = 'collapse-toggle';
          collapseBtn.innerHTML = '‚ñº';
          collapseBtn.title = category.collapsed ? '–†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏' : '–ó–≥–æ—Ä–Ω—É—Ç–∏';
          collapseBtn.onclick = (e) => {
            e.stopPropagation();
            toggleCategoryCollapse(categoryKey);
          };
          categoryHeaderTop.appendChild(collapseBtn);

          // –Ü–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (–∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É)
          if (category.icon && category.icon.startsWith('data:')) {
            const img = document.createElement('img');
            img.src = category.icon;
            img.className = 'custom-image';
            img.style.cursor = 'zoom-in';
            img.onclick = (e) => {
              e.stopPropagation();
              openImageModal(category.icon);
            };
            categoryHeaderTop.appendChild(img);
          } else {
            const iconSpan = document.createElement('span');
            iconSpan.className = 'category-icon';
            iconSpan.textContent = category.icon || 'üìÅ';
            categoryHeaderTop.appendChild(iconSpan);
          }

          // –ù–∞–∑–≤–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó
          const titleSpan = document.createElement('span');
          titleSpan.className = 'category-title';
          titleSpan.textContent = category.title;
          categoryHeaderTop.appendChild(titleSpan);

          categoryHeader.appendChild(categoryHeaderTop);

          // –î—Ä—É–≥–∏–π —Ä—è–¥ - –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
          const categoryControls = document.createElement('div');
          categoryControls.className = 'category-controls';

          // –ö–Ω–æ–ø–∫–∏ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
          const sortControls = document.createElement('div');
          sortControls.className = 'sort-controls';

          const upBtn = document.createElement('button');
          upBtn.className = 'sort-btn';
          upBtn.innerHTML = '‚¨ÜÔ∏è';
          upBtn.title = '–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –≤–≥–æ—Ä—É';
          upBtn.disabled = catIndex === 0;
          upBtn.onclick = (e) => {
            e.stopPropagation();
            moveCategoryUp(categoryKey);
          };
          sortControls.appendChild(upBtn);

          const downBtn = document.createElement('button');
          downBtn.className = 'sort-btn';
          downBtn.innerHTML = '‚¨áÔ∏è';
          downBtn.title = '–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –≤–Ω–∏–∑';
          downBtn.disabled = catIndex === sortedKeys.length - 1;
          downBtn.onclick = (e) => {
            e.stopPropagation();
            moveCategoryDown(categoryKey);
          };
          sortControls.appendChild(downBtn);

          categoryControls.appendChild(sortControls);

          const editBtn = document.createElement('button');
          editBtn.className = 'category-action-btn';
          editBtn.innerHTML = '‚úèÔ∏è';
          editBtn.title = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é';
          editBtn.onclick = (e) => {
            e.stopPropagation();
            openEditCategoryModal(categoryKey);
          };
          categoryControls.appendChild(editBtn);

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'category-action-btn delete';
          deleteBtn.innerHTML = 'üóëÔ∏è';
          deleteBtn.title = '–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—é';
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            e.preventDefault();
            deleteCategory(categoryKey);
            return false;
          };
          categoryControls.appendChild(deleteBtn);

          categoryHeader.appendChild(categoryControls);
          categoryDiv.appendChild(categoryHeader);

          // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –¥–æ—Å—è–≥–Ω–µ–Ω—å
          const itemsContainer = document.createElement('div');
          itemsContainer.className = 'category-items';

          // –î–æ–¥–∞—î–º–æ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
          category.items.forEach((achievement, achIndex) => {
            const achievementDiv = document.createElement('div');
            achievementDiv.className = `achievement ${achievement.unlocked ? 'unlocked' : 'locked'}`;

            // –ü–ï–†–®–ò–ô –†–Ø–î - –æ—Å–Ω–æ–≤–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç
            const achievementMain = document.createElement('div');
            achievementMain.className = 'achievement-main';
            achievementMain.onclick = () =>
              toggleAchievement(categoryKey, achievement.id);

            // –Ü–∫–æ–Ω–∫–∞ –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è (–∫–ª—ñ–∫–∞–±–µ–ª—å–Ω–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É)
            if (achievement.image && achievement.image.startsWith('data:')) {
              const img = document.createElement('img');
              img.src = achievement.image;
              img.className = 'custom-image achievement-icon';
              img.style.cursor = 'zoom-in';
              img.onclick = (e) => {
                e.stopPropagation();
                openImageModal(achievement.image);
              };
              achievementMain.appendChild(img);
            } else if (achievement.icon) {
              const iconSpan = document.createElement('span');
              iconSpan.className = 'achievement-icon';
              iconSpan.textContent = achievement.icon;
              achievementMain.appendChild(iconSpan);
            } else {
              const iconSpan = document.createElement('span');
              iconSpan.className = 'achievement-icon';
              iconSpan.textContent = '‚≠ê';
              achievementMain.appendChild(iconSpan);
            }

            // –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
            const contentDiv = document.createElement('div');
            contentDiv.className = 'achievement-content';

            const nameDiv = document.createElement('div');
            nameDiv.className = 'achievement-name';
            nameDiv.textContent = achievement.name;
            contentDiv.appendChild(nameDiv);

            if (achievement.description) {
              const descDiv = document.createElement('div');
              descDiv.className = 'achievement-description';
              descDiv.textContent = achievement.description;
              contentDiv.appendChild(descDiv);
            }

            achievementMain.appendChild(contentDiv);
            achievementDiv.appendChild(achievementMain);

            // –î–†–£–ì–ò–ô –†–Ø–î - –≤—Å—ñ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
            const achievementControls = document.createElement('div');
            achievementControls.className = 'achievement-controls';

            // –ö–Ω–æ–ø–∫–∏ —Å–æ—Ä—Ç—É–≤–∞–Ω–Ω—è
            const sortControls = document.createElement('div');
            sortControls.className = 'sort-controls';

            const upBtn = document.createElement('button');
            upBtn.className = 'sort-btn';
            upBtn.innerHTML = '‚¨ÜÔ∏è';
            upBtn.title = '–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –≤–≥–æ—Ä—É';
            upBtn.disabled = achIndex === 0;
            upBtn.onclick = (e) => {
              e.stopPropagation();
              moveAchievementUp(categoryKey, achievement.id);
            };
            sortControls.appendChild(upBtn);

            const downBtn = document.createElement('button');
            downBtn.className = 'sort-btn';
            downBtn.innerHTML = '‚¨áÔ∏è';
            upBtn.title = '–ü–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –≤–Ω–∏–∑';
            downBtn.disabled = achIndex === category.items.length - 1;
            downBtn.onclick = (e) => {
              e.stopPropagation();
              moveAchievementDown(categoryKey, achievement.id);
            };
            sortControls.appendChild(downBtn);

            achievementControls.appendChild(sortControls);

            const editBtn = document.createElement('button');
            editBtn.className = 'action-btn edit-btn';
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.title = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏';
            editBtn.onclick = (e) => {
              e.stopPropagation();
              openEditModal(categoryKey, achievement.id);
            };
            achievementControls.appendChild(editBtn);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'action-btn delete-btn';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.title = '–í–∏–¥–∞–ª–∏—Ç–∏';
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              e.preventDefault();
              deleteAchievement(categoryKey, achievement.id);
              return false;
            };
            achievementControls.appendChild(deleteBtn);

            achievementDiv.appendChild(achievementControls);
            itemsContainer.appendChild(achievementDiv);
          });

          categoryDiv.appendChild(itemsContainer);
          container.appendChild(categoryDiv);
        });

        updateStats();
      }

      // –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É –¥–æ—Å—è–≥–Ω–µ–Ω–Ω—è
      function toggleAchievement(categoryKey, achievementId) {
        const category = achievements[categoryKey];
        const achievement = category.items.find((a) => a.id === achievementId);

        if (achievement) {
          const wasUnlocked = achievement.unlocked;
          achievement.unlocked = !achievement.unlocked;

          if (achievement.unlocked && !wasUnlocked) {
            showUnlockModal(achievement);
          }

          saveProgress();
          renderAchievements();
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
      function showUnlockModal(achievement) {
        const modal = document.getElementById('achievementModal');
        const iconDisplay = achievement.image
          ? `<img src="${achievement.image}" style="max-width: 100px; max-height: 100px; border-radius: 10px;">`
          : achievement.icon || 'üéâ';
        document.getElementById('modalIcon').innerHTML = iconDisplay;
        document.getElementById('modalTitle').textContent = achievement.name;
        document.getElementById('modalDescription').textContent =
          achievement.description || '';
        modal.classList.add('active');
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
      function closeModal() {
        document.getElementById('achievementModal').classList.remove('active');
      }

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —É –ø–æ–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä
      function openImageModal(imageSrc) {
        document.getElementById('imageModalImg').src = imageSrc;
        document.getElementById('imageModal').classList.add('active');
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
      function closeImageModal() {
        document.getElementById('imageModal').classList.remove('active');
      }

      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      function updateStats() {
        let unlockedCount = 0;
        let totalCount = 0;

        Object.keys(achievements).forEach((categoryKey) => {
          achievements[categoryKey].items.forEach((achievement) => {
            totalCount++;
            if (achievement.unlocked) {
              unlockedCount++;
            }
          });
        });

        document.getElementById('unlockedCount').textContent = unlockedCount;
        document.getElementById('totalCount').textContent = totalCount;
      }

      // === –ï–ö–°–ü–û–†–¢/–Ü–ú–ü–û–†–¢ –î–ê–ù–ò–• ===

      // –ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö —É JSON —Ñ–∞–π–ª
      function exportData() {
        try {
          const data = {
            achievements: achievements,
            nextId: nextId,
            exportDate: new Date().toISOString(),
            version: '1.0',
          };

          const dataStr = JSON.stringify(data, null, 2);
          const fileName =
            'life-achievements-' +
            new Date().toISOString().split('T')[0] +
            '.json';

          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —Ü–µ iOS/Mobile Safari
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

          if (isIOS) {
            // –î–ª—è iOS: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ Share API —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π
            const blob = new Blob([dataStr], { type: 'application/json' });
            const file = new File([blob], fileName, {
              type: 'application/json',
            });

            if (
              navigator.share &&
              navigator.canShare &&
              navigator.canShare({ files: [file] })
            ) {
              navigator
                .share({
                  files: [file],
                  title: '–ï–∫—Å–ø–æ—Ä—Ç –¥–æ—Å—è–≥–Ω–µ–Ω—å',
                  text: '–†–µ–∑–µ—Ä–≤–Ω–∞ –∫–æ–ø—ñ—è –º–æ—ó—Ö –¥–æ—Å—è–≥–Ω–µ–Ω—å',
                })
                .then(() => {
                  // Share completed
                })
                .catch((error) => {
                  if (error.name !== 'AbortError') {
                    console.error('Share error:', error);
                    // Fallback: –ø–æ–∫–∞–∑–∞—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
                    showExportDataModal(dataStr, fileName);
                  }
                });
            } else {
              // Fallback: –ø–æ–∫–∞–∑–∞—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è
              showExportDataModal(dataStr, fileName);
            }
          } else {
            // –î–ª—è —ñ–Ω—à–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º: –∑–≤–∏—á–∞–π–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = fileName;

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!\n\n–§–∞–π–ª: ' + fileName);
          }
        } catch (error) {
          console.error('Export error:', error);
          alert('–ü–æ–º–∏–ª–∫–∞ –µ–∫—Å–ø–æ—Ä—Ç—É: ' + error.message);
        }
      }

      // –ü–æ–∫–∞–∑–∞—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∑ –¥–∞–Ω–∏–º–∏ –¥–ª—è –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è (–¥–ª—è iOS fallback)
      function showExportDataModal(dataStr, fileName) {
        const modal = document.createElement('div');
        modal.style.cssText =
          'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;justify-content:center;align-items:center;padding:20px;';

        const content = document.createElement('div');
        content.style.cssText =
          'background:white;border-radius:15px;padding:20px;max-width:500px;width:100%;max-height:80vh;overflow:auto;';

        const title = document.createElement('h2');
        title.textContent = 'üì• –ï–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö';
        title.style.cssText = 'color:#667eea;margin-top:0;';
        content.appendChild(title);

        const instructions = document.createElement('p');
        instructions.textContent =
          '–°–∫–æ–ø—ñ—é–π—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∏–∂—á–µ —Ç–∞ –∑–±–µ—Ä–µ–∂—ñ—Ç—å —É —Ñ–∞–π–ª "' + fileName + '":';
        instructions.style.cssText = 'color:#666;margin-bottom:15px;';
        content.appendChild(instructions);

        const textarea = document.createElement('textarea');
        textarea.value = dataStr;
        textarea.readOnly = true;
        textarea.style.cssText =
          'width:100%;min-height:200px;padding:10px;border:2px solid #667eea;border-radius:8px;font-family:monospace;font-size:12px;margin-bottom:15px;box-sizing:border-box;';
        content.appendChild(textarea);

        const btnContainer = document.createElement('div');
        btnContainer.style.cssText = 'display:flex;gap:10px;';

        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏';
        copyBtn.style.cssText =
          'flex:1;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:none;padding:12px;border-radius:8px;font-size:16px;cursor:pointer;';
        copyBtn.onclick = () => {
          textarea.select();
          document.execCommand('copy');
          copyBtn.textContent = '‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!';
          setTimeout(() => {
            copyBtn.textContent = 'üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏';
          }, 2000);
        };
        btnContainer.appendChild(copyBtn);

        const closeBtn = document.createElement('button');
        closeBtn.textContent = '–ó–∞–∫—Ä–∏—Ç–∏';
        closeBtn.style.cssText =
          'flex:1;background:#e0e0e0;color:#333;border:none;padding:12px;border-radius:8px;font-size:16px;cursor:pointer;';
        closeBtn.onclick = () => {
          document.body.removeChild(modal);
        };
        btnContainer.appendChild(closeBtn);

        content.appendChild(btnContainer);
        modal.appendChild(content);

        modal.onclick = (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };

        document.body.appendChild(modal);
        textarea.select();
      }

      // –Ü–º–ø–æ—Ä—Ç –¥–∞–Ω–∏—Ö –∑ JSON —Ñ–∞–π–ª—É
      function importData() {
        document.getElementById('confirmImportModal').classList.add('active');
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—É
      function closeConfirmImport() {
        document
          .getElementById('confirmImportModal')
          .classList.remove('active');
      }

      // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —ñ–º–ø–æ—Ä—Ç
      function confirmImport() {
        closeConfirmImport();
        document.getElementById('importFile').click();
      }

      // –û–±—Ä–æ–±–∫–∞ —ñ–º–ø–æ—Ä—Ç—É —Ñ–∞–π–ª—É
      function handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = function (e) {
          try {
            const data = JSON.parse(e.target.result);

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ –¥–∞–Ω–∏—Ö
            if (!data.achievements || !data.nextId) {
              throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É');
            }

            // –í—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö
            achievements = data.achievements;
            nextId = data.nextId;

            saveProgress();
            renderAchievements();

            alert(
              '‚úÖ –î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ!\n\n–î–∞—Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É: ' +
                (data.exportDate
                  ? new Date(data.exportDate).toLocaleString('uk-UA')
                  : '–Ω–µ–≤—ñ–¥–æ–º–∞'),
            );
          } catch (error) {
            console.error('Import error:', error);
            alert(
              '–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ' +
                error.message +
                '\n\n–ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è —â–æ —Ñ–∞–π–ª –Ω–µ –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏–π.',
            );
          }
        };

        reader.onerror = function () {
          alert('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É');
        };

        reader.readAsText(file);

        // –û—á–∏—â–∞—î–º–æ input –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —ñ–º–ø–æ—Ä—Ç—É —Ç–æ–≥–æ —Å–∞–º–æ–≥–æ —Ñ–∞–π–ª—É –∑–Ω–æ–≤—É
        event.target.value = '';
      }

      // === –°–ö–ò–î–ê–ù–ù–Ø –î–ê–ù–ò–• ===

      // –í—ñ–¥–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Å–∫–∏–¥–∞–Ω–Ω—è
      function openConfirmReset() {
        document.getElementById('confirmResetModal').classList.add('active');
      }

      // –ó–∞–∫—Ä–∏—Ç–∏ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Å–∫–∏–¥–∞–Ω–Ω—è
      function closeConfirmReset() {
        document.getElementById('confirmResetModal').classList.remove('active');
      }

      // –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Å–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö
      function confirmReset() {
        // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –¥–∞–Ω—ñ
        localStorage.removeItem('lifeAchievements');

        // –ü–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ —Å–∫–∏–¥–∞–Ω–Ω—è
        location.reload();
      }

      // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω –ø–æ –∫–ª—ñ–∫—É –Ω–∞ —Ñ–æ–Ω
      document
        .getElementById('formModal')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeFormModal();
          }
        });

      document
        .getElementById('categoryModal')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeCategoryModal();
          }
        });

      document
        .getElementById('achievementModal')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeModal();
          }
        });

      document
        .getElementById('confirmResetModal')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeConfirmReset();
          }
        });

      document
        .getElementById('confirmDeleteModal')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeConfirmDelete();
          }
        });

      document
        .getElementById('storageInfoModal')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeStorageInfo();
          }
        });

      document
        .getElementById('confirmImportModal')
        .addEventListener('click', function (e) {
          if (e.target === this) {
            closeConfirmImport();
          }
        });

      // Settings modal handlers and utilities
      function openSettingsModal() {
        document.getElementById('themeColor1').value =
          settings.color1 || '#667eea';
        document.getElementById('themeColor2').value =
          settings.color2 || '#764ba2';
        document.getElementById('themeAngle').value = settings.angle || 135;
        updateGradientPreview();
        document.getElementById('settingsModal').classList.add('active');
      }

      function closeSettingsModal() {
        document.getElementById('settingsModal').classList.remove('active');
      }

      function updateGradientPreview() {
        const c1 = document.getElementById('themeColor1').value;
        const c2 = document.getElementById('themeColor2').value;
        const angle = document.getElementById('themeAngle').value || 135;
        const preview = document.getElementById('gradientPreview');
        if (preview) {
          preview.style.background = `linear-gradient(${angle}deg, ${c1} 0%, ${c2} 100%)`;
        }
      }

      document
        .getElementById('themeColor1')
        .addEventListener('input', updateGradientPreview);
      document
        .getElementById('themeColor2')
        .addEventListener('input', updateGradientPreview);
      document
        .getElementById('themeAngle')
        .addEventListener('input', updateGradientPreview);

      function saveSettings(e) {
        e.preventDefault();
        const c1 = document.getElementById('themeColor1').value;
        const c2 = document.getElementById('themeColor2').value;
        const angle =
          parseInt(document.getElementById('themeAngle').value, 10) || 135;
        settings.color1 = c1;
        settings.color2 = c2;
        settings.angle = angle;
        settings.useGradient = true;
        applySettings();
        saveProgress();
        closeSettingsModal();
      }

      // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
      loadProgress();
      applySettings();
      renderAchievements();
    </script>

    <!-- Service Worker Registration –¥–ª—è PWA -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker
            .register('service-worker.js')
            .then((registration) => {
              console.log('‚úÖ Service Worker –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–æ:', registration);
              // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω—å
              setInterval(() => {
                registration.update();
              }, 60000); // –ö–æ–∂–Ω—É —Ö–≤–∏–ª–∏–Ω—É
            })
            .catch((error) => {
              console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó Service Worker:', error);
            });
        });
      } else {
        console.warn('Service Worker –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è —Ü–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
      }
    </script>
  </body>
</html>
